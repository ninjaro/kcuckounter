name: Checks

on:
  pull_request:
    branches:
      - master
    paths:
      - 'src/**/*.cpp'
      - 'include/**/*.hpp'
      - 'tests/**/*.cpp'
      - 'CMakeLists.txt'
      - '.github/workflows/tests.yml'
      - 'scripts/ci/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.*'
          target: 'desktop'
          install-deps: 'true'
          cache: 'true'

      - name: Configure (non-KDE Debug)
        id: build_tests
        continue-on-error: true
        run: ./scripts/ci/build_test.sh
        env:
          CI_LOG_FILE: .ci-logs/build-test-nonkde.log
          QT_QPA_PLATFORM: offscreen
          JUNIT_OUTPUT: .ci-logs/build-test-nonkde-junit.xml

      - name: Collect test report
        if: always()
        id: test_report
        run: python scripts/ci/collect_test_report.py
        env:
          JUNIT_REPORT: ${{ steps.build_tests.outputs.junit_file || '.ci-logs/build-test-nonkde-junit.xml' }}
          TEST_LOG: ${{ steps.build_tests.outputs.log_file || '.ci-logs/build-test-nonkde.log' }}

      - name: Comment test summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reportedTotal = Number('${{ steps.test_report.outputs.tests_total }}' || 0);
            const reportedPassed = Number('${{ steps.test_report.outputs.tests_passed }}' || 0);
            const reportedFailed = Number('${{ steps.test_report.outputs.tests_failed }}' || 0);
            const total = reportedTotal || (reportedPassed + reportedFailed);
            const passed = total ? Math.max(total - reportedFailed, 0) : 0;
            const buildStatus = ('${{ steps.build_tests.outcome }}' === 'success' || total > 0) ? 'passed' : 'failed';
            const failedList = `${{ steps.test_report.outputs.failed_tests }}`.trim();
            const failures = failedList ? failedList.split('\n') : [];
            const failuresBlock = failures.length
              ? failures.map(name => `- ${name}`).join('\n')
              : (reportedFailed > 0 ? '- (see log output for failing test names)' : '- None');
            const body = [
              'CI Summary',
              '',
              `Build: ${buildStatus}`,
              `Tests passed: ${passed}/${total}`,
              'Failed tests:',
              failuresBlock
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if build/tests failed
        if: always()
        run: |
          if [ "${{ steps.build_tests.outcome }}" != "success" ]; then
            echo "Build/tests failed."
            exit 1
          fi

  sanitizer:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.*'
          target: 'desktop'
          install-deps: 'true'
          cache: 'true'

      - name: Configure & run sanitizers (non-KDE Debug)
        id: build_sanitizer
        continue-on-error: true
        run: ./scripts/ci/build_sanitizer.sh
        env:
          CI_LOG_FILE: .ci-logs/build-test-sanitizer.log
          QT_QPA_PLATFORM: offscreen

      - name: Fail if sanitizer build/tests failed
        if: always()
        run: |
          if [ "${{ steps.build_sanitizer.outcome }}" != "success" ]; then
            echo "Sanitizer build/tests failed."
            exit 1
          fi


  code-style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clang-format
        uses: jidicula/clang-format-action@6cd220de46c89139a0365edae93eee8eb30ca8fe
        with:
          clang-format-version: '21'
          check-path: '.'

  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.*'
          target: 'desktop'
          install-deps: 'true'
          cache: 'true'

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy

      - name: Configure (non-KDE Debug)
        run: cmake -S . -B build-clang-tidy -DCMAKE_BUILD_TYPE=Debug -DKDE=OFF -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build Qt autogen files
        run: cmake --build build-clang-tidy --target kcuckounter_autogen kcuckounter_unittests_autogen

      - name: Run clang-tidy
        run: run-clang-tidy -p build-clang-tidy
